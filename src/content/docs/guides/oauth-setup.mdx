---
title: Google OAuth Setup
description: Create Google Cloud OAuth credentials and authorize msgvault, including headless server setup.
---

msgvault requires OAuth credentials to access the Gmail API. This guide walks through the complete setup.

## Step 1: Create a Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Note your project ID

## Step 2: Enable the Gmail API

1. Navigate to **APIs & Services > Library**
2. Search for "Gmail API"
3. Click **Enable**

## Step 3: Configure OAuth Consent Screen

1. Go to **APIs & Services > OAuth consent screen**
2. Choose **External** user type (or **Internal** for Google Workspace)
3. Fill in required fields:
   - App name: `msgvault`
   - User support email: your email
   - Developer contact email: your email
4. Click **Save and Continue**
5. On the Scopes page, click **Add or Remove Scopes**
6. Add the scope: `https://www.googleapis.com/auth/gmail.modify`
7. Save and continue through the remaining screens
8. Under **Test users**, add all Gmail addresses you want to sync

:::note
The `gmail.modify` scope enables deletion features while sync operations remain read-only. When you first run `delete-staged`, msgvault will prompt you to upgrade to full `mail.google.com` access for batch deletion.
:::

## Step 4: Create OAuth Client Credentials

1. Go to **APIs & Services > Credentials**
2. Click **Create Credentials > OAuth client ID**
3. Choose **Desktop application** as the application type
4. Name it `msgvault` (or similar)
5. Click **Create**
6. Download the JSON file
7. Save it as `client_secret.json` in a secure location

:::caution
Never commit `client_secret.json` to version control.
:::

:::caution[Desktop Application Only]
You must choose **Desktop application** as the client type. Do not use "TVs and Limited Input devices" as Google's device code flow does not support Gmail scopes.
:::

## Step 5: Configure msgvault

Create `~/.msgvault/config.toml`:

```toml
[oauth]
client_secrets = "/path/to/your/client_secret.json"

[sync]
rate_limit_qps = 5
```

## Step 6: Add Your Account

```bash
msgvault add-account you@gmail.com
```

This opens your browser to Google's OAuth consent page. Sign in, grant access, and tokens are stored locally in `~/.msgvault/tokens/`.

## Headless Server Setup

When running msgvault on a headless server (SSH, VPS, Docker), there is no browser available for OAuth. Google's device code flow does not support Gmail scopes, so you must authorize on a machine with a browser and copy the token to your server.

Run `--headless` to see the setup instructions:

```bash
msgvault add-account you@gmail.com --headless
```

This prints:

```
=== Headless Server Setup ===

Google's OAuth device flow does not support Gmail scopes, so --headless
cannot directly authorize. Instead, authorize on a machine with a browser
and copy the token to your server.

Step 1: On a machine with a browser, run:

    msgvault add-account you@gmail.com

Step 2: Copy the token file to your headless server:

    ssh user@server mkdir -p '~/.msgvault/tokens'
    scp '~/.msgvault/tokens/you@gmail.com.json' user@server:'~/.msgvault/tokens/you@gmail.com.json'

Step 3: On the headless server, register the account:

    msgvault add-account you@gmail.com

The token will be detected and the account registered. No browser needed.
```

### Step-by-Step

1. **On your local machine** (with a browser), install msgvault and run:
   ```bash
   msgvault add-account you@gmail.com
   ```
   Complete the OAuth flow in your browser.

2. **Copy the token** to your headless server:
   ```bash
   ssh user@server mkdir -p ~/.msgvault/tokens
   scp ~/.msgvault/tokens/you@gmail.com.json user@server:~/.msgvault/tokens/
   ```

3. **On the headless server**, register the account:
   ```bash
   msgvault add-account you@gmail.com
   ```
   msgvault detects the existing token and registers the account. Output:
   ```
   Account you@gmail.com is ready.
   You can now run: msgvault sync-full you@gmail.com
   ```

4. **Sync your email**:
   ```bash
   msgvault sync-full you@gmail.com
   ```

The token file contains OAuth refresh tokens that are automatically renewed. You only need to copy it once unless you revoke access.

:::note
Both machines must have the same `client_secret.json` configured, or use the same OAuth client credentials. The token is tied to the OAuth client that created it.
:::
